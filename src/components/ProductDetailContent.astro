---
import Breadcrumbs from "./Breadcrumbs.astro";
import AffiliateButton from "./AffiliateButton.astro";
import type { Product, Toplist } from "../utils/data";
import { childSubcategoryUrl, subcategoryToplistUrl } from "../utils/routes";

const {
  product,
  verdict,
  relatedToplist,
  relatedChildsubcategory,
  breadcrumbItems = [],
  showBreadcrumbs = true,
  showBackLink = true,
  showCloseButton = false
} = Astro.props as {
  product: Product;
  verdict: string;
  relatedToplist?: Toplist | null;
  relatedChildsubcategory?: { name: string; slug: string } | null;
  breadcrumbItems?: Array<{ name: string; href: string }>;
  showBreadcrumbs?: boolean;
  showBackLink?: boolean;
  showCloseButton?: boolean;
};
---

<article class="page-container" data-drawer-fragment>
  <div class="mx-auto w-full max-w-3xl">
    <header class="space-y-3">
      {showBreadcrumbs ? (
        <div class="flex flex-wrap items-center justify-between gap-3 text-sm text-ink/60">
          <Breadcrumbs items={breadcrumbItems} />
          <div class="flex items-center gap-2">
            {showBackLink ? <a id="smart-back" class="btn-ghost hidden" href="/">Back</a> : null}
            {showCloseButton ? (
              <button class="btn-ghost text-sm" type="button" data-drawer-close>Close</button>
            ) : null}
          </div>
        </div>
      ) : (
        showCloseButton ? (
          <div class="flex justify-end">
            <button class="btn-ghost text-sm" type="button" data-drawer-close>Close</button>
          </div>
        ) : null
      )}
      <h1 class="text-3xl font-semibold text-ink" data-drawer-title>{product.name}</h1>
    </header>

    <section class="mt-6">
      <div class="flex justify-center rounded-2xl bg-slate-50 px-6 py-6">
        <img
          class="h-auto w-full max-w-sm object-contain sm:max-w-md md:max-w-lg"
          src={product.image}
          alt={product.name}
          loading="lazy"
          decoding="async"
          width="800"
          height="500"
          onerror="this.onerror=null;this.src='/images/products/placeholder.svg';"
        />
      </div>
    </section>

    <section class="mt-8">
      <h2 class="text-xl font-semibold text-ink">Short verdict</h2>
      <p class="mt-3 max-w-2xl text-base font-medium leading-relaxed text-ink/80 sm:text-lg">
        {verdict}
      </p>
    </section>

    <div class="mt-5">
      <AffiliateButton url={product.affiliateUrl} label="View on Amazon" productSlug={product.slug} />
    </div>

    <p class="mt-6 text-base leading-relaxed text-ink/70">{product.description}</p>

    <section class="mt-10">
      <h2 class="text-xl font-semibold text-ink">Pros and cons</h2>
      <div class="mt-4 grid gap-6 text-sm text-ink/70 md:grid-cols-2">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-ink">Pros</p>
          <ul class="mt-3 list-disc list-inside space-y-2">
            {product.pros.map((item) => (
              <li>{item}</li>
            ))}
          </ul>
        </div>
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-ink">Cons</p>
          <ul class="mt-3 list-disc list-inside space-y-2">
            {product.cons.map((item) => (
              <li>{item}</li>
            ))}
          </ul>
        </div>
      </div>
    </section>

    <section class="mt-10">
      <h2 class="text-xl font-semibold text-ink">Who this is best for</h2>
      <p class="mt-3 text-ink/70">{product.bestFor}</p>
      {product.notIdealFor ? <p class="mt-2 text-sm text-ink/60">Not ideal for: {product.notIdealFor}</p> : null}
    </section>

    <section class="mt-10">
      <h2 class="text-xl font-semibold text-ink">Key details</h2>
      <ul class="mt-3 list-disc list-inside space-y-2 text-ink/70">
        {Object.entries(product.specs).map(([label, value]) => (
          <li><strong>{label}:</strong> {value}</li>
        ))}
      </ul>
    </section>

    {relatedToplist ? (
      <section class="mt-10">
        <h2 class="text-xl font-semibold text-ink">See the full list</h2>
        <p class="mt-2 text-sm text-ink/70">
          <a
            class="text-accent"
            href={relatedChildsubcategory
              ? childSubcategoryUrl(
                  relatedToplist.category,
                  relatedToplist.subcategory,
                  relatedToplist.childsubcategory
                )
              : subcategoryToplistUrl(
                  relatedToplist.category,
                  relatedToplist.subcategory,
                  relatedToplist.count,
                  relatedToplist.keywordSlug
                )}
          >
            {relatedToplist.title}
          </a>
        </p>
      </section>
    ) : null}
  </div>
</article>
