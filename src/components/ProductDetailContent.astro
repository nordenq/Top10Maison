---
import ProductDetailLayout from "./ProductDetailLayout.astro";
import type { Product, Toplist } from "../utils/data";
import { childSubcategoryUrl, subcategoryToplistUrl } from "../utils/routes";

const {
  product,
  verdict,
  relatedToplist,
  relatedChildsubcategory,
  breadcrumbItems = [],
  showBreadcrumbs = true,
  showBackLink = true,
  showCloseButton = false
} = Astro.props as {
  product: Product;
  verdict: string;
  relatedToplist?: Toplist | null;
  relatedChildsubcategory?: { name: string; slug: string } | null;
  breadcrumbItems?: Array<{ name: string; href: string }>;
  showBreadcrumbs?: boolean;
  showBackLink?: boolean;
  showCloseButton?: boolean;
};

const verdictText = verdict.trim();
const verdictSentences = verdictText.split(/(?<=\.)\s+/);
const heroVerdict = verdictSentences[0] ?? verdictText;
const verdictRemainder = verdictSentences.slice(1).join(" ").trim();
const descriptionTextRaw = product.description?.trim() ?? "";
const descriptionTrimmed = descriptionTextRaw.startsWith(heroVerdict)
  ? descriptionTextRaw.slice(heroVerdict.length).trim()
  : descriptionTextRaw;
const descriptionText = descriptionTrimmed && descriptionTrimmed !== verdictRemainder ? descriptionTrimmed : "";
---

<ProductDetailLayout
  product={product}
  verdict={heroVerdict}
  breadcrumbItems={breadcrumbItems}
  showBreadcrumbs={showBreadcrumbs}
  showBackLink={showBackLink}
  showCloseButton={showCloseButton}
>
  {verdictRemainder ? (
    <section>
      <h2 class="text-xl font-semibold text-ink">Verdict details</h2>
      <p class="mt-3 max-w-2xl text-base leading-relaxed text-ink/70">{verdictRemainder}</p>
    </section>
  ) : null}

  {descriptionText ? (
    <section>
      <h2 class="text-xl font-semibold text-ink">Product overview</h2>
      <p class="mt-3 text-base leading-relaxed text-ink/70">{descriptionText}</p>
    </section>
  ) : null}

  <section>
    <h2 class="text-xl font-semibold text-ink">Pros and cons</h2>
    <div class="mt-4 grid gap-6 text-sm text-ink/70 md:grid-cols-2">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-ink">Pros</p>
        <ul class="mt-3 list-disc list-inside space-y-2">
          {product.pros.map((item) => (
            <li>{item}</li>
          ))}
        </ul>
      </div>
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-ink">Cons</p>
        <ul class="mt-3 list-disc list-inside space-y-2">
          {product.cons.map((item) => (
            <li>{item}</li>
          ))}
        </ul>
      </div>
    </div>
  </section>

  <section>
    <h2 class="text-xl font-semibold text-ink">Who this is best for</h2>
    <p class="mt-3 text-ink/70">{product.bestFor}</p>
    {product.notIdealFor ? <p class="mt-2 text-sm text-ink/60">Not ideal for: {product.notIdealFor}</p> : null}
  </section>

  <section>
    <h2 class="text-xl font-semibold text-ink">Key details</h2>
    <ul class="mt-3 list-disc list-inside space-y-2 text-ink/70">
      {Object.entries(product.specs).map(([label, value]) => (
        <li><strong>{label}:</strong> {value}</li>
      ))}
    </ul>
  </section>

  {relatedToplist ? (
    <section>
      <h2 class="text-xl font-semibold text-ink">See the full list</h2>
      <p class="mt-2 text-sm text-ink/70">
        <a
          class="text-accent"
          href={relatedChildsubcategory
            ? childSubcategoryUrl(
                relatedToplist.category,
                relatedToplist.subcategory,
                relatedToplist.childsubcategory
              )
            : subcategoryToplistUrl(
                relatedToplist.category,
                relatedToplist.subcategory,
                relatedToplist.count,
                relatedToplist.keywordSlug
              )}
        >
          {relatedToplist.title}
        </a>
      </p>
    </section>
  ) : null}
</ProductDetailLayout>
