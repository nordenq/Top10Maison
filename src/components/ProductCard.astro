---
import { CSP_NONCE } from "../utils/csp";

export interface Props {
  product: {
    name: string;
    image: string;
    price: string;
    rating?: number;
    brand?: string;
    affiliateUrl: string;
    badge?: string;
    slug?: string;
    description?: string;
    reviewSnippet?: string;
    pros?: string[];
    cons?: string[];
  };
  rank: number;
  schema?: boolean;
  loading?: "lazy" | "eager";
  fetchpriority?: "high" | "low";
}

const { product, rank, schema = false, loading = "lazy", fetchpriority } = Astro.props as Props;
const productLink = product.slug ? `/product/${product.slug}/` : null;
const productSchema =
  schema && product.name && product.image
    ? {
        "@context": "https://schema.org",
        "@type": "Product",
        name: product.name,
        url: product.affiliateUrl,
        image: product.image,
        ...(product.brand ? { brand: { "@type": "Brand", name: product.brand } } : {}),
        ...(product.rating
          ? {
              aggregateRating: {
                "@type": "AggregateRating",
                ratingValue: product.rating,
                reviewCount: 1
              }
            }
          : {})
      }
    : null;
---

<article class="card card-hover group grid overflow-hidden md:grid-cols-[240px_1fr]">
  <div class="relative flex aspect-[4/3] w-full items-center justify-center overflow-hidden bg-gradient-to-br from-accent-soft to-surface md:aspect-auto md:h-full md:px-5 md:py-6">
    <img
      src={product.image}
      alt={product.name}
      class="h-36 w-auto max-w-[85%] object-contain sm:h-40 md:h-44 lg:h-48"
      loading={loading}
      fetchpriority={fetchpriority}
      decoding="async"
      width="400"
      height="300"
      onerror="this.onerror=null;this.src='/images/products/placeholder.svg';"
    />
    {product.badge ? (
      <span class="absolute left-3 top-3 rounded-md bg-accent px-2 py-0.5 text-xs font-semibold text-white">
        {product.badge}
      </span>
    ) : null}
    <span class="absolute right-3 top-3 rounded-full bg-surface/90 px-2.5 py-0.5 text-xs font-semibold text-ink">
      #{rank}
    </span>
  </div>

  <div class="flex flex-1 flex-col p-5 md:py-6 md:pr-6">
    <h3 class="text-lg font-semibold leading-snug">
      {productLink ? <a class="card-link" href={productLink} data-drawer-link>{product.name}</a> : product.name}
    </h3>
    {product.brand ? <p class="mt-1 text-sm text-ink/60">By {product.brand}</p> : null}
    <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-ink/70">
      <span class="rounded-full bg-accent-soft px-3 py-1 text-ink">{product.price}</span>
      {product.rating ? <span class="text-warning">Rating: {product.rating} â˜…</span> : null}
    </div>
    {product.reviewSnippet || product.description ? (
      <p class="mt-4 text-sm text-ink/70">{product.reviewSnippet ?? product.description}</p>
    ) : null}
    {product.pros?.length || product.cons?.length ? (
      <div class="mt-4 grid gap-4 text-sm text-ink/70 lg:grid-cols-2">
        {product.pros?.length ? (
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-ink">Pros</p>
            <ul class="mt-2 list-disc list-inside space-y-1">
              {product.pros.slice(0, 3).map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        ) : null}
        {product.cons?.length ? (
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-ink">Cons</p>
            <ul class="mt-2 list-disc list-inside space-y-1">
              {product.cons.slice(0, 2).map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        ) : null}
      </div>
    ) : null}
    <div class="mt-auto pt-4">
      <div class="flex flex-wrap items-center gap-3">
        <a
          href={product.affiliateUrl}
          target="_blank"
          rel="nofollow sponsored noopener"
          class="btn text-sm"
        >
          View on Amazon
        </a>
        {productLink ? <a class="btn-ghost text-sm" href={productLink} data-drawer-link>Read review</a> : null}
      </div>
    </div>
  </div>
  {productSchema ? (
    <script type="application/ld+json" nonce={CSP_NONCE} set:html={JSON.stringify(productSchema)} />
  ) : null}
</article>
