---
export interface Props {
  product: {
    name: string;
    image: string;
    price: string;
    rating?: number;
    brand?: string;
    affiliateUrl: string;
    badge?: string;
    slug?: string;
  };
  rank: number;
  schema?: boolean;
}

const { product, rank, schema = false } = Astro.props as Props;
const productLink = product.slug ? `/product/${product.slug}/` : null;
const priceValue = product.price ? product.price.replace(/[^0-9.]/g, "") : "";
const productSchema =
  schema && product.name && product.image
    ? {
        "@context": "https://schema.org",
        "@type": "Product",
        name: product.name,
        url: product.affiliateUrl,
        image: product.image,
        ...(product.brand ? { brand: { "@type": "Brand", name: product.brand } } : {}),
        ...(product.rating
          ? {
              aggregateRating: {
                "@type": "AggregateRating",
                ratingValue: product.rating,
                reviewCount: 1
              }
            }
          : {}),
        ...(priceValue || product.affiliateUrl
          ? {
              offers: {
                "@type": "Offer",
                ...(priceValue ? { price: priceValue, priceCurrency: "USD" } : {}),
                ...(product.affiliateUrl ? { url: product.affiliateUrl } : {})
              }
            }
          : {})
      }
    : null;
---

<article class="flex flex-col items-center gap-6 rounded-2xl bg-white p-6 shadow-sm transition hover:shadow-md sm:flex-row">
  <div class="relative">
    <img
      src={product.image}
      alt={product.name}
      class="h-32 w-32 rounded-xl object-contain"
      loading="lazy"
      width="128"
      height="128"
    />
    {product.badge ? (
      <span class="absolute left-2 top-2 rounded-md bg-accent px-2 py-0.5 text-xs font-semibold text-white">
        {product.badge}
      </span>
    ) : null}
  </div>

  <div class="flex-1">
    <h3 class="mb-1 text-lg font-semibold">
      #{rank} – {productLink ? <a href={productLink}>{product.name}</a> : product.name}
    </h3>
    {product.brand ? <p class="text-sm text-slate-500">By {product.brand}</p> : null}
    <p class="mt-2 text-sm text-slate-700">Price: {product.price}</p>
    {product.rating ? (
      <p class="mt-1 text-sm text-yellow-500">Rating: {product.rating} ★</p>
    ) : null}
    <div class="mt-4 flex flex-wrap items-center gap-3">
      <a
        href={product.affiliateUrl}
        target="_blank"
        rel="nofollow sponsored noopener"
        class="btn text-sm"
      >
        View on Amazon
      </a>
      {productLink ? <a class="btn-ghost text-sm" href={productLink}>Read review</a> : null}
    </div>
  </div>
  {productSchema ? (
    <script type="application/ld+json" is:inline>
      {JSON.stringify(productSchema, null, 2)}
    </script>
  ) : null}
</article>
