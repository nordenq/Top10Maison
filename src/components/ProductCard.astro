---
import type { Product } from "../utils/data";
import { productUrl } from "../utils/routes";
import AffiliateButton from "./AffiliateButton.astro";

const {
  product,
  rank,
  badge,
  rating,
  brand,
  ctaLabel = "Check price",
  ctaUrl
} = Astro.props as {
  product: Product;
  rank?: number;
  badge?: string;
  rating?: number;
  brand?: string;
  ctaLabel?: string;
  ctaUrl?: string;
};

const productName = product.name;
const productImage = product.image;
const productDescription = product.description;
const productPrice = product.price;
const effectiveCtaUrl = ctaUrl ?? product.affiliateUrl;
const priceValue = productPrice ? productPrice.replace(/[^0-9.]/g, "") : "";
const offers =
  priceValue || effectiveCtaUrl
    ? {
        "@type": "Offer",
        ...(priceValue ? { price: priceValue, priceCurrency: "USD" } : {}),
        ...(effectiveCtaUrl ? { url: effectiveCtaUrl } : {})
      }
    : undefined;
const aggregateRating =
  typeof rating === "number"
    ? {
        "@type": "AggregateRating",
        ratingValue: rating,
        reviewCount: 1
      }
    : undefined;
const productSchema =
  productName && productImage
    ? {
        "@context": "https://schema.org",
        "@type": "Product",
        name: productName,
        image: productImage,
        description: productDescription,
        ...(brand ? { brand: { "@type": "Brand", name: brand } } : {}),
        ...(offers ? { offers } : {}),
        ...(aggregateRating ? { aggregateRating } : {})
      }
    : null;
---

<article class="card grid gap-6 p-6 md:grid-cols-[220px_1fr]">
  <div class="relative">
    {rank ? (
      <span class="absolute left-3 top-3 rounded-full bg-ink px-3 py-1 text-xs font-semibold text-white">
        #{rank}
      </span>
    ) : null}
    {badge ? (
      <span class="absolute right-3 top-3 rounded-full bg-success/10 px-3 py-1 text-xs font-semibold text-success">
        {badge}
      </span>
    ) : null}
    <a href={productUrl(product.slug)}>
      <img
        class="h-48 w-full rounded-xl object-cover"
        src={productImage}
        alt={productName}
        loading="lazy"
        width="640"
        height="360"
      />
    </a>
  </div>
  <div class="flex flex-col gap-3">
    <div>
      <h3 class="text-xl font-semibold">
        <a href={productUrl(product.slug)}>{productName}</a>
      </h3>
      <p class="mt-2 text-sm text-ink/70">{productDescription}</p>
    </div>
    <div class="flex flex-wrap items-center gap-3 text-sm text-ink/70">
      {productPrice ? <span class="rounded-full bg-background px-3 py-1">{productPrice}</span> : null}
      {typeof rating === "number" ? (
        <span class="rounded-full bg-success/10 px-3 py-1 text-success">{rating.toFixed(1)} rating</span>
      ) : null}
    </div>
    <div class="mt-auto flex flex-wrap items-center gap-3">
      {effectiveCtaUrl ? (
        <AffiliateButton url={effectiveCtaUrl} label={ctaLabel} productSlug={product.slug} />
      ) : null}
      <a class="btn-ghost" href={productUrl(product.slug)}>Read review</a>
    </div>
  </div>
  {productSchema ? (
    <script type="application/ld+json">{JSON.stringify(productSchema)}</script>
  ) : null}
</article>
