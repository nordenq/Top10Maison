---
import type { Product, Toplist } from "../utils/data";
import AffiliateButton from "./AffiliateButton.astro";
import { childSubcategoryUrl, subcategoryToplistUrl } from "../utils/routes";

const {
  product,
  shortVerdict,
  relatedToplist,
  relatedChildsubcategory
} = Astro.props as {
  product: Product;
  shortVerdict: string;
  relatedToplist?: Toplist | null;
  relatedChildsubcategory?: { name: string; slug: string } | null;
};

const glanceKeys = [
  { label: "Capacity", key: "Capacity" },
  { label: "Power", key: "Power" },
  { label: "Controls", key: "Controls" },
  { label: "Basket type", key: "Basket type" },
  { label: "Dishwasher safe", key: "Dishwasher safe parts" },
  { label: "Noise level", key: "Noise level" }
];
const glanceItems = glanceKeys
  .map((item) => ({ ...item, value: product.specs[item.key] }))
  .filter((item) => item.value);
---

<article class="space-y-6" data-drawer-fragment>
  <span class="sr-only" data-drawer-title>{product.name}</span>
  <span class="sr-only" data-drawer-verdict>{shortVerdict}</span>

  <section class="card p-5">
    <div class="flex justify-center">
      <img
        class="h-56 w-auto max-w-full object-contain"
        src={product.image}
        alt={product.name}
        loading="lazy"
        decoding="async"
        width="400"
        height="300"
        onerror="this.onerror=null;this.src='/images/products/placeholder.svg';"
      />
    </div>
    <div class="mt-4">
      <AffiliateButton url={product.affiliateUrl} label="View on Amazon" productSlug={product.slug} />
    </div>
  </section>

  {glanceItems.length ? (
    <section>
      <h3 class="text-sm font-semibold uppercase tracking-wide text-ink">At a glance</h3>
      <div class="mt-3 grid gap-3 text-sm text-ink/70 sm:grid-cols-2">
        {glanceItems.map((item) => (
          <div class="flex items-start justify-between gap-3 rounded-xl border border-border bg-surface px-3 py-2">
            <span class="text-ink/60">{item.label}</span>
            <span class="text-right font-medium text-ink">{item.value}</span>
          </div>
        ))}
      </div>
    </section>
  ) : null}

  <section>
    <h3 class="text-sm font-semibold uppercase tracking-wide text-ink">Pros and cons</h3>
    <div class="mt-3 grid gap-4 text-sm text-ink/70 md:grid-cols-2">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-ink">Pros</p>
        <ul class="mt-2 list-disc list-inside space-y-1">
          {product.pros.slice(0, 4).map((item) => (
            <li>{item}</li>
          ))}
        </ul>
      </div>
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-ink">Cons</p>
        <ul class="mt-2 list-disc list-inside space-y-1">
          {product.cons.slice(0, 4).map((item) => (
            <li>{item}</li>
          ))}
        </ul>
      </div>
    </div>
  </section>

  <section>
    <h3 class="text-sm font-semibold uppercase tracking-wide text-ink">Who this is best for</h3>
    <div class="mt-3 rounded-xl border border-border bg-surface p-4 text-sm text-ink/70">
      <p><strong>Best for:</strong> {product.bestFor}</p>
      {product.notIdealFor ? <p class="mt-2 text-ink/60"><strong>Not ideal for:</strong> {product.notIdealFor}</p> : null}
    </div>
  </section>

  <section>
    <details class="card p-4">
      <summary class="cursor-pointer text-sm font-semibold text-ink">Detailed specs</summary>
      <ul class="mt-3 list-disc list-inside space-y-2 text-sm text-ink/70">
        {Object.entries(product.specs).map(([label, value]) => (
          <li><strong>{label}:</strong> {value}</li>
        ))}
      </ul>
    </details>
  </section>

  {relatedToplist ? (
    <section>
      <a
        class="text-sm font-semibold text-accent"
        href={relatedChildsubcategory
          ? childSubcategoryUrl(relatedToplist.category, relatedToplist.subcategory, relatedToplist.childsubcategory)
          : subcategoryToplistUrl(relatedToplist.category, relatedToplist.subcategory, relatedToplist.count, relatedToplist.keywordSlug)}
      >
        ‚Üê See the full list
      </a>
    </section>
  ) : null}
</article>
