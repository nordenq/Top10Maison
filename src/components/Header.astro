---
import { buildDataIndex } from "../utils/data";
import { homeUrl } from "../utils/routes";
import CategoryNav from "./CategoryNav.astro";

const { categories } = buildDataIndex();
---

<header
  id="site-header"
  class="sticky top-0 z-20 border-b border-border bg-white/95 backdrop-blur transition-shadow"
>
  <div class="page-container flex w-full items-center justify-between py-4">
    <a class="text-lg font-semibold tracking-tight" href={homeUrl()}>Top10Maison</a>
    <nav class="hidden items-center gap-6 text-sm font-medium md:flex" aria-label="Primary">
      <a href={homeUrl()}>Home</a>
      <a href="/#top-categories">Categories</a>
      <a href="/about/">About</a>
      <a href="/contact/">Contact</a>
    </nav>
    <button
      id="mobile-menu-button"
      class="md:hidden rounded-xl border border-border px-3 py-2 text-sm font-medium"
      type="button"
      aria-expanded="false"
      aria-controls="mobile-menu"
      aria-label="Toggle menu"
    >
      Menu
    </button>
  </div>
  <div class="hidden border-t border-border bg-white md:block">
    <div class="page-container py-3">
      <CategoryNav categories={categories} />
    </div>
  </div>
  <div id="mobile-menu" class="hidden border-t border-border bg-white md:hidden">
    <nav class="space-y-4 px-6 py-4 text-sm" aria-label="Mobile">
      <a class="block font-medium" href={homeUrl()}>Home</a>
      <a class="block font-medium" href="/about/">About</a>
      <a class="block font-medium" href="/contact/">Contact</a>
      <details class="rounded-xl border border-border p-3">
        <summary class="cursor-pointer font-semibold">Categories</summary>
        <div class="mt-3 grid gap-2">
          {categories.map((category) => (
            <a class="rounded-lg bg-background px-3 py-2" href={`/category/${category.slug}/`}>
              {category.name}
            </a>
          ))}
        </div>
      </details>
    </nav>
  </div>
</header>

<script>
  const header = document.getElementById('site-header');
  const menuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  let ticking = false;

  function updateScrollState() {
    if (!header) {
      return;
    }
    header.dataset.scrolled = window.scrollY > 12 ? 'true' : 'false';
    ticking = false;
  }

  window.addEventListener(
    'scroll',
    function () {
      if (ticking) {
        return;
      }
      ticking = true;
      window.requestAnimationFrame(updateScrollState);
    },
    { passive: true }
  );
  updateScrollState();

  function setMenuState(isOpen) {
    if (!mobileMenu || !menuButton) {
      return;
    }
    mobileMenu.classList.toggle('hidden', !isOpen);
    mobileMenu.setAttribute('aria-hidden', (!isOpen).toString());
    menuButton.setAttribute('aria-expanded', isOpen.toString());
    if (isOpen) {
      const firstLink = mobileMenu.querySelector('a, summary');
      if (firstLink instanceof HTMLElement) {
        firstLink.focus();
      }
    } else {
      menuButton.focus();
    }
  }

  menuButton?.addEventListener('click', function () {
    if (!mobileMenu || !menuButton) {
      return;
    }
    const isOpen = !mobileMenu.classList.contains('hidden');
    setMenuState(!isOpen);
  });

  if (mobileMenu) {
    mobileMenu.setAttribute('aria-hidden', 'true');
  }
</script>
