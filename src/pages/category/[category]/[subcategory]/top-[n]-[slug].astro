---
import Layout from "../../../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../../../components/Breadcrumbs.astro";
import FAQAccordion from "../../../../components/FAQAccordion.astro";
import ProductGridSection from "../../../../components/ProductGridSection.astro";
import BulletListSection from "../../../../components/BulletListSection.astro";
import { getTopListData } from "../../../../utils/data";
import { getDataIndex } from "../../../../utils/dataIndex";
import { buildCanonical, requireSite } from "../../../../utils/seo";
import { buildArticleSchema, buildBreadcrumbSchema, buildFaqSchema, buildItemListSchema, buildProductSchema } from "../../../../utils/schema";
import { categoryUrl, subcategoryUrl, subcategoryToplistUrl, productUrl } from "../../../../utils/routes";
import { getToplistDisplay } from "../../../../utils/toplistDisplay";

export function getStaticPaths() {
  const { toplists } = getDataIndex();
  return toplists.map((list) => ({
    params: {
      category: list.category,
      subcategory: list.subcategory,
      n: String(list.count),
      slug: list.keywordSlug
    }
  }));
}

const { category, subcategory, n, slug } = Astro.params;
const toplist = getTopListData(category, subcategory, n, slug);

const site = requireSite(Astro.site);
const canonical = buildCanonical(site, subcategoryToplistUrl(category, subcategory, Number(n), slug));
const ogImage = toplist.list.image ?? toplist.category.image ?? "/logo.svg";
const dataIndex = getDataIndex();
const display = getToplistDisplay(toplist.list, dataIndex);
const productsWithBadges = toplist.products.map((product, index) => ({
  ...product,
  badge: toplist.list.productBadges?.[product.slug] ?? (index === 0 ? "Best Overall" : undefined)
}));
const breadcrumbItems = [
  { name: "Home", path: "/" },
  { name: "Categories", path: "/categories/" },
  { name: toplist.category.name, path: categoryUrl(toplist.category.slug) },
  { name: toplist.subcategory.name, path: subcategoryUrl(toplist.category.slug, toplist.subcategory.slug) },
  { name: toplist.title, path: subcategoryToplistUrl(category, subcategory, Number(n), slug) }
];

const breadcrumbLinks = [
  { name: "Home", href: "/" },
  { name: "Categories", href: "/categories/" },
  { name: toplist.category.name, href: categoryUrl(toplist.category.slug) },
  { name: toplist.subcategory.name, href: subcategoryUrl(toplist.category.slug, toplist.subcategory.slug) },
  { name: toplist.title, href: subcategoryToplistUrl(category, subcategory, Number(n), slug) }
];
const verdict = toplist.childsubcategory
  ? `Best for shoppers comparing ${toplist.childsubcategory.name.toLowerCase()} with a focus on real-world performance.`
  : `Best for shoppers comparing ${toplist.subcategory.name.toLowerCase()} with a focus on real-world performance.`;
const schema = [
  buildBreadcrumbSchema(site, breadcrumbItems),
  buildArticleSchema(site, { ...toplist.list, schemaHeadline: display.schemaHeadline }, canonical),
  buildItemListSchema(
    toplist.products.map((product) => ({
      name: product.name,
      url: new URL(productUrl(product.slug), site).toString()
    }))
  ),
  buildFaqSchema(toplist.faq),
  ...toplist.products.map((product) => buildProductSchema(site, product))
];
---

<Layout
  title={display.metaTitle}
  description={toplist.list.metaDescription || toplist.description}
  canonical={canonical}
  schema={schema}
  ogImage={ogImage}
  ogType="article"
>
  <section class="section">
    <div class="page-container">
      <Breadcrumbs items={breadcrumbLinks} />
    </div>
  </section>
  <section class="section">
    <div class="page-container">
      <h1 class="text-3xl font-semibold">{display.h1}</h1>
      <p class="mt-3 text-lg text-ink/70">{display.intro}</p>
    </div>
  </section>

  {toplist.list.articleHtml ? (
    <section class="section">
      <div class="page-container">
        <div class="article-content" set:html={toplist.list.articleHtml} />
      </div>
    </section>
  ) : null}

  <section class="section">
    <div class="page-container">
      <h2 class="text-2xl font-semibold">Verdict</h2>
      <p class="mt-3 text-sm text-ink/70">{verdict}</p>
    </div>
  </section>

  <ProductGridSection title="Top Picks" products={productsWithBadges} schema />

  {toplist.selectionCriteria.length ? (
    <BulletListSection title="How We Picked" items={toplist.selectionCriteria} />
  ) : null}

  {toplist.faq?.length ? (
    <FAQAccordion items={toplist.faq} />
  ) : null}
</Layout>
