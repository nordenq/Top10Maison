---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../../../components/Breadcrumbs.astro";
import ChildSubcategoryGrid from "../../../../components/ChildSubcategoryGrid.astro";
import FaqSection from "../../../../components/FaqSection.astro";
import IntentComparisonTable from "../../../../components/IntentComparisonTable.astro";
import PageHero from "../../../../components/PageHero.astro";
import { buildDataIndex } from "../../../../utils/data";
import { categoryUrl, subcategoryUrl } from "../../../../utils/routes";
import { buildCanonical, buildTitle, requireSite } from "../../../../utils/seo";
import { buildBreadcrumbSchema, buildFaqSchema } from "../../../../utils/schema";

// Routing explanation:
// /category/[category]/[subcategory]/index.astro maps to /category/{category-slug}/{subcategory-slug}/.
// getStaticPaths enumerates every subcategory from JSON so no runtime routing exists.

export function getStaticPaths() {
  const { categories } = buildDataIndex();
  return categories.flatMap((category) =>
    category.subcategories.map((subcategory) => ({
      params: {
        category: category.slug,
        subcategory: subcategory.slug
      }
    }))
  );
}

const { categories } = buildDataIndex();
const paramsCategory = Astro.params.category;
const paramsSubcategory = Astro.params.subcategory;

const category = categories.find((item) => item.slug === paramsCategory);
if (!category) {
  throw new Error(`Missing category data for slug: ${paramsCategory}`);
}

const subcategory = category.subcategories.find((item) => item.slug === paramsSubcategory);
if (!subcategory) {
  throw new Error(`Missing subcategory data for slug: ${paramsCategory}:${paramsSubcategory}`);
}

const site = requireSite(Astro.site);
const title = buildTitle(`Best ${subcategory.name} for Your Home`, "Top10Maison");
const description = subcategory.description;
const canonical = buildCanonical(site, subcategoryUrl(category.slug, subcategory.slug));
const breadcrumbItems = [
  { name: "Home", href: "/" },
  { name: category.name, href: categoryUrl(category.slug) },
  { name: subcategory.name, href: subcategoryUrl(category.slug, subcategory.slug) }
];
const schema = [
  buildBreadcrumbSchema(site, [
    { name: "Home", path: "/" },
    { name: category.name, path: categoryUrl(category.slug) },
    { name: subcategory.name, path: subcategoryUrl(category.slug, subcategory.slug) }
  ]),
  buildFaqSchema(subcategory.faq)
];
---

<BaseLayout title={title} description={description} canonical={canonical} schema={schema}>
  <Breadcrumbs items={breadcrumbItems} />
  <PageHero title={`Best ${subcategory.name} for Your Home`} intro={subcategory.intentCopy} />

  <ChildSubcategoryGrid category={category} subcategory={subcategory} />

  <IntentComparisonTable rows={subcategory.intentTable} />

  <FaqSection items={subcategory.faq} />
</BaseLayout>
