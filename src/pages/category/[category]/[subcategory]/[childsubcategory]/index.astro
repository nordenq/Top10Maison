---
import BaseLayout from "../../../../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../../../../components/Breadcrumbs.astro";
import FaqSection from "../../../../../components/FaqSection.astro";
import IntentComparisonTable from "../../../../../components/IntentComparisonTable.astro";
import PageHero from "../../../../../components/PageHero.astro";
import TopListsPreviewGrid from "../../../../../components/TopListsPreviewGrid.astro";
import { buildDataIndex } from "../../../../../utils/data";
import { categoryUrl, childSubcategoryUrl, subcategoryUrl } from "../../../../../utils/routes";
import { buildCanonical, buildTitle, requireSite } from "../../../../../utils/seo";
import { buildBreadcrumbSchema, buildFaqSchema } from "../../../../../utils/schema";

// Routing explanation:
// /category/[category]/[subcategory]/[childsubcategory]/index.astro maps to
// /category/{category-slug}/{subcategory-slug}/{child-subcategory-slug}/.
// getStaticPaths enumerates every child subcategory from JSON so no runtime routing exists.

export function getStaticPaths() {
  const { categories } = buildDataIndex();
  return categories.flatMap((category) =>
    category.subcategories.flatMap((subcategory) =>
      subcategory.subcategories.map((childsubcategory) => ({
        params: {
          category: category.slug,
          subcategory: subcategory.slug,
          childsubcategory: childsubcategory.slug
        }
      }))
    )
  );
}

const { categories, toplists } = buildDataIndex();
const paramsCategory = Astro.params.category;
const paramsSubcategory = Astro.params.subcategory;
const paramsChildSubcategory = Astro.params.childsubcategory;

const category = categories.find((item) => item.slug === paramsCategory);
if (!category) {
  throw new Error(`Missing category data for slug: ${paramsCategory}`);
}

const subcategory = category.subcategories.find((item) => item.slug === paramsSubcategory);
if (!subcategory) {
  throw new Error(`Missing subcategory data for slug: ${paramsCategory}:${paramsSubcategory}`);
}

const childsubcategory = subcategory.subcategories.find((item) => item.slug === paramsChildSubcategory);
if (!childsubcategory) {
  throw new Error(
    `Missing child subcategory data for slug: ${paramsCategory}:${paramsSubcategory}:${paramsChildSubcategory}`
  );
}

const childToplists = toplists.filter(
  (list) =>
    list.category === category.slug &&
    list.subcategory === subcategory.slug &&
    list.childsubcategory === childsubcategory.slug
);

if (childToplists.length === 0) {
  throw new Error(`Child subcategory ${paramsCategory}:${paramsSubcategory}:${paramsChildSubcategory} has no toplists.`);
}

const site = requireSite(Astro.site);
const title = buildTitle(`Best ${childsubcategory.name} for Your Home`, "Top10Maison");
const description = childsubcategory.description;
const canonical = buildCanonical(site, childSubcategoryUrl(category.slug, subcategory.slug, childsubcategory.slug));
const breadcrumbItems = [
  { name: "Home", href: "/" },
  { name: category.name, href: categoryUrl(category.slug) },
  { name: subcategory.name, href: subcategoryUrl(category.slug, subcategory.slug) },
  { name: childsubcategory.name, href: childSubcategoryUrl(category.slug, subcategory.slug, childsubcategory.slug) }
];
const schema = [
  buildBreadcrumbSchema(site, [
    { name: "Home", path: "/" },
    { name: category.name, path: categoryUrl(category.slug) },
    { name: subcategory.name, path: subcategoryUrl(category.slug, subcategory.slug) },
    { name: childsubcategory.name, path: childSubcategoryUrl(category.slug, subcategory.slug, childsubcategory.slug) }
  ]),
  buildFaqSchema(childsubcategory.faq)
];
---

<BaseLayout title={title} description={description} canonical={canonical} schema={schema}>
  <Breadcrumbs items={breadcrumbItems} />
  <PageHero title={`Best ${childsubcategory.name} for Your Home`} intro={childsubcategory.intentCopy} />

  <TopListsPreviewGrid toplists={childToplists} title="Top list previews" />

  <IntentComparisonTable rows={childsubcategory.intentTable} />

  <FaqSection items={childsubcategory.faq} />
</BaseLayout>
