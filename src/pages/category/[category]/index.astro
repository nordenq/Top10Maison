---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";
import FaqSection from "../../../components/FaqSection.astro";
import HowToChoose from "../../../components/HowToChoose.astro";
import PageHero from "../../../components/PageHero.astro";
import SubcategoryGrid from "../../../components/SubcategoryGrid.astro";
import TopListsRail from "../../../components/TopListsRail.astro";
import { buildDataIndex } from "../../../utils/data";
import { categoryUrl } from "../../../utils/routes";
import { buildCanonical, buildTitle, requireSite } from "../../../utils/seo";
import { buildBreadcrumbSchema, buildFaqSchema } from "../../../utils/schema";

// Routing explanation:
// /category/[category]/index.astro maps to /category/{category-slug}/.
// getStaticPaths enumerates every category from JSON so routes are static at build time.

export function getStaticPaths() {
  const { categories } = buildDataIndex();
  return categories.map((category) => ({
    params: { category: category.slug }
  }));
}

const { categories, toplists } = buildDataIndex();
const paramsCategory = Astro.params.category;

const category = categories.find((item) => item.slug === paramsCategory);
if (!category) {
  throw new Error(`Missing category data for slug: ${paramsCategory}`);
}

const categoryToplists = toplists
  .filter((list) => list.category === category.slug)
  .sort((a, b) => b.performanceScore - a.performanceScore);

if (categoryToplists.length === 0) {
  throw new Error(`Category ${category.slug} has no toplists for internal linking.`);
}

const featuredToplists = categoryToplists.slice(0, 3);

const site = requireSite(Astro.site);
const title = buildTitle(`${category.name} Buying Guides & Reviews`, "Top10Maison");
const description = category.description;
const canonical = buildCanonical(site, categoryUrl(category.slug));
const breadcrumbItems = [
  { name: "Home", href: "/" },
  { name: category.name, href: categoryUrl(category.slug) }
];
const schema = [
  buildBreadcrumbSchema(site, [
    { name: "Home", path: "/" },
    { name: category.name, path: categoryUrl(category.slug) }
  ]),
  buildFaqSchema(category.faq)
];
---

<BaseLayout title={title} description={description} canonical={canonical} schema={schema}>
  <Breadcrumbs items={breadcrumbItems} />
  <PageHero title={`${category.name} Buying Guides & Reviews`} intro={category.intro} />

  <SubcategoryGrid category={category} />

  <HowToChoose title="How to choose" bullets={category.howToChoose} />

  <FaqSection items={category.faq} />

  <TopListsRail toplists={featuredToplists} title="Best-performing top lists" />
</BaseLayout>
