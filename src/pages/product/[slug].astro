---
import Layout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import { getProductData } from "../../utils/data";
import { getDataIndex } from "../../utils/dataIndex";
import { buildCanonical, requireSite } from "../../utils/seo";
import { buildBreadcrumbSchema, buildFaqSchema, buildProductSchema, buildReviewSchema } from "../../utils/schema";
import { categoryUrl, childSubcategoryUrl, productUrl, subcategoryToplistUrl, subcategoryUrl } from "../../utils/routes";
import AffiliateButton from "../../components/AffiliateButton.astro";
import FAQAccordion from "../../components/FAQAccordion.astro";

const dataIndex = getDataIndex();

export function getStaticPaths() {
  const { products } = getDataIndex();
  return products.map((product) => ({
    params: { slug: product.slug }
  }));
}

const { slug } = Astro.params;
const product = getProductData(slug);
const { toplists, productMap, categoryMap, subcategoryMap, childSubcategoryMap } = dataIndex;
const relatedToplist = toplists.find((list) => list.products.includes(product.slug));
const relatedCategory = relatedToplist ? categoryMap.get(relatedToplist.category) : null;
const relatedSubcategory = relatedToplist
  ? subcategoryMap.get(`${relatedToplist.category}:${relatedToplist.subcategory}`)
  : null;
const relatedChildsubcategory = relatedToplist
  ? childSubcategoryMap.get(
      `${relatedToplist.category}:${relatedToplist.subcategory}:${relatedToplist.childsubcategory}`
    )
  : null;
const relatedProducts = relatedToplist
  ? relatedToplist.products
      .filter((productSlug) => productSlug !== product.slug)
      .map((productSlug) => productMap.get(productSlug))
      .filter((item): item is NonNullable<typeof item> => Boolean(item))
  : [];

const pageTitle = `${product.name} Review â€“ Pros, Cons & Who It's Best For`;
const verdict = product.reviewSnippet ?? product.description;

const site = requireSite(Astro.site);
const canonical = buildCanonical(site, productUrl(product.slug));
const breadcrumbItems =
  relatedCategory && relatedSubcategory && relatedChildsubcategory
    ? [
        { name: "Home", href: "/" },
        { name: relatedCategory.name, href: categoryUrl(relatedCategory.slug) },
        {
          name: relatedSubcategory.name,
          href: subcategoryUrl(relatedCategory.slug, relatedSubcategory.slug)
        },
        {
          name: relatedChildsubcategory.name,
          href: childSubcategoryUrl(relatedCategory.slug, relatedSubcategory.slug, relatedChildsubcategory.slug)
        },
        { name: product.name, href: productUrl(product.slug) }
      ]
    : [
        { name: "Home", href: "/" },
        { name: product.name, href: productUrl(product.slug) }
      ];
const schema = [
  buildBreadcrumbSchema(
    site,
    breadcrumbItems.map((item) => ({ name: item.name, path: item.href }))
  ),
  buildProductSchema(site, product),
  buildReviewSchema(site, product),
  buildFaqSchema(product.faq)
];
---

<Layout
  title={pageTitle}
  description={product.metaDescription || product.description}
  canonical={canonical}
  schema={schema}
  ogImage={product.image}
  ogType="product"
>
  <section class="section">
    <article class="page-container">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <Breadcrumbs items={breadcrumbItems} />
        <a id="smart-back" class="btn-ghost hidden" href="/">Back</a>
      </div>
      <h1 class="text-3xl font-semibold">{product.name}</h1>
      <img
        class="mt-6 rounded-xl bg-slate-50 object-contain"
        src={product.image}
        alt={product.name}
        loading="lazy"
        decoding="async"
        width="800"
        height="500"
        onerror="this.onerror=null;this.src='/images/products/placeholder.svg';"
      />
      <p class="mt-4 text-lg text-ink/70">{product.description}</p>

      <div class="mt-6">
        <AffiliateButton url={product.affiliateUrl} label="View on Amazon" productSlug={product.slug} />
      </div>

      <section class="mt-10">
        <h2 class="text-xl font-semibold">Short verdict</h2>
        <p class="mt-3 text-ink/70">{verdict}</p>
      </section>

      <section class="mt-10">
        <h2 class="text-xl font-semibold">Pros and cons</h2>
        <div class="mt-4 grid gap-6 text-sm text-ink/70 md:grid-cols-2">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-ink">Pros</p>
            <ul class="mt-3 list-disc list-inside space-y-2">
              {product.pros.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-ink">Cons</p>
            <ul class="mt-3 list-disc list-inside space-y-2">
              {product.cons.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        </div>
      </section>

      <section class="mt-10">
        <h2 class="text-xl font-semibold">Who this is best for</h2>
        <p class="mt-3 text-ink/70">{product.bestFor}</p>
        {product.notIdealFor ? <p class="mt-2 text-sm text-ink/60">Not ideal for: {product.notIdealFor}</p> : null}
      </section>

      <section class="mt-10">
        <h2 class="text-xl font-semibold">Specifications</h2>
        <ul class="mt-3 list-disc list-inside space-y-2 text-ink/70">
          {Object.entries(product.specs).map(([label, value]) => (
            <li><strong>{label}:</strong> {value}</li>
          ))}
        </ul>
      </section>

      {relatedToplist ? (
        <section class="mt-10">
          <h2 class="text-xl font-semibold">See the full list</h2>
          <p class="mt-2 text-sm text-ink/70">
            <a
              class="text-accent"
              href={relatedChildsubcategory
                ? childSubcategoryUrl(
                    relatedToplist.category,
                    relatedToplist.subcategory,
                    relatedToplist.childsubcategory
                  )
                : subcategoryToplistUrl(
                    relatedToplist.category,
                    relatedToplist.subcategory,
                    relatedToplist.count,
                    relatedToplist.keywordSlug
                  )}
            >
              {relatedToplist.title}
            </a>
          </p>
        </section>
      ) : null}

      {relatedProducts.length ? (
        <section class="mt-10">
          <h2 class="text-xl font-semibold">Related products</h2>
          <ul class="mt-3 list-disc list-inside space-y-2 text-ink/70">
            {relatedProducts.map((item) => (
              <li><a class="text-accent" href={productUrl(item.slug)}>{item.name}</a></li>
            ))}
          </ul>
        </section>
      ) : null}

      {product.faq?.length ? <FAQAccordion items={product.faq} /> : null}
    </article>
  </section>
</Layout>
