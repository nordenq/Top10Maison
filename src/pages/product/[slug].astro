---
import Layout from "../../layouts/BaseLayout.astro";
import { getProductData } from "../../utils/data";
import { getDataIndex } from "../../utils/dataIndex";
import { buildCanonical, requireSite } from "../../utils/seo";
import { buildBreadcrumbSchema, buildProductSchema, buildReviewSchema } from "../../utils/schema";
import { categoryUrl, childSubcategoryUrl, productUrl, subcategoryToplistUrl, subcategoryUrl } from "../../utils/routes";
import ProductDetailLayout from "../../components/ProductDetailLayout.astro";
import ProductDrawerContent from "../../components/ProductDrawerContent.astro";

const dataIndex = getDataIndex();

export function getStaticPaths() {
  const { products } = getDataIndex();
  return products.map((product) => ({
    params: { slug: product.slug }
  }));
}

const { slug } = Astro.params;
const product = getProductData(slug);
const { toplists, categoryMap, subcategoryMap, childSubcategoryMap } = dataIndex;
const relatedToplist = toplists.find((list) => list.products.includes(product.slug));
const relatedCategory = relatedToplist ? categoryMap.get(relatedToplist.category) : null;
const relatedSubcategory = relatedToplist
  ? subcategoryMap.get(`${relatedToplist.category}:${relatedToplist.subcategory}`)
  : null;
const relatedChildsubcategory = relatedToplist
  ? childSubcategoryMap.get(
      `${relatedToplist.category}:${relatedToplist.subcategory}:${relatedToplist.childsubcategory}`
    )
  : null;

const pageTitle = `${product.name} Review â€“ Pros, Cons & Who It's Best For`;
const verdict = product.reviewSnippet ?? product.description;
const descriptionText = product.description;
const verdictCombined =
  product.reviewSnippet && product.reviewSnippet.trim() !== descriptionText.trim()
    ? `${product.reviewSnippet} ${descriptionText}`
    : verdict;
const shortVerdict = verdict.split(/(?<=\.)\s+/)[0] ?? verdict;
const isDrawer = Astro.url.searchParams.get("drawer") === "1";

const site = requireSite(Astro.site);
const canonical = buildCanonical(site, productUrl(product.slug));
const breadcrumbItems =
  relatedCategory && relatedSubcategory && relatedChildsubcategory
    ? [
        { name: "Home", href: "/" },
        { name: relatedCategory.name, href: categoryUrl(relatedCategory.slug) },
        {
          name: relatedSubcategory.name,
          href: subcategoryUrl(relatedCategory.slug, relatedSubcategory.slug)
        },
        {
          name: relatedChildsubcategory.name,
          href: childSubcategoryUrl(relatedCategory.slug, relatedSubcategory.slug, relatedChildsubcategory.slug)
        },
        { name: product.name, href: productUrl(product.slug) }
      ]
    : [
        { name: "Home", href: "/" },
        { name: product.name, href: productUrl(product.slug) }
      ];
const schema = [
  buildBreadcrumbSchema(
    site,
    breadcrumbItems.map((item) => ({ name: item.name, path: item.href }))
  ),
  buildProductSchema(site, product),
  buildReviewSchema(site, product)
];
const backLink = relatedToplist
  ? {
      label: relatedToplist.title,
      href: relatedChildsubcategory
        ? childSubcategoryUrl(
            relatedToplist.category,
            relatedToplist.subcategory,
            relatedToplist.childsubcategory
          )
        : subcategoryToplistUrl(
            relatedToplist.category,
            relatedToplist.subcategory,
            relatedToplist.count,
            relatedToplist.keywordSlug
          )
    }
  : { label: "Browse categories", href: "/categories/" };
---

{isDrawer ? (
  <ProductDrawerContent
    product={product}
    shortVerdict={shortVerdict}
    relatedToplist={relatedToplist}
    relatedChildsubcategory={relatedChildsubcategory}
  />
) : (
  <Layout
    title={pageTitle}
    description={product.metaDescription || product.description}
    canonical={canonical}
    schema={schema}
    ogImage={product.image}
    ogType="product"
  >
    <section class="section">
      <ProductDetailLayout
        title={product.name}
        image={product.image}
        verdict={verdictCombined}
        ctaUrl={product.affiliateUrl}
        pros={product.pros}
        cons={product.cons}
        bestFor={[product.bestFor]}
        notFor={[product.notIdealFor]}
        specs={Object.entries(product.specs).map(([label, value]) => ({ label, value }))}
        backLink={backLink}
      />
    </section>
  </Layout>
)}
