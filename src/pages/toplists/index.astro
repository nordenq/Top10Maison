---
import Layout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import { getDataIndex } from "../../utils/dataIndex";
import { buildCanonical, requireSite } from "../../utils/seo";
import { buildBreadcrumbSchema, buildItemListSchema } from "../../utils/schema";
import { childSubcategoryUrl, subcategoryToplistUrl } from "../../utils/routes";

const { categories, toplists, categoryMap, subcategoryMap, childSubcategoryMap } = getDataIndex();
const site = requireSite(Astro.site);
const title = "All Top Lists";
const description = "Browse every Top10Maison top list across all categories, organized for quick scanning and SEO-friendly navigation.";
const canonical = buildCanonical(site, "/toplists/");
const breadcrumbItems = [
  { name: "Home", path: "/" },
  { name: "Top Lists", path: "/toplists/" }
];

const bestByChild = new Map<string, (typeof toplists)[number]>();
for (const list of toplists) {
  if (!list.childsubcategory) continue;
  const key = `${list.category}:${list.subcategory}:${list.childsubcategory}`;
  const existing = bestByChild.get(key);
  if (!existing) {
    bestByChild.set(key, list);
    continue;
  }
  if (
    list.performanceScore > existing.performanceScore ||
    (list.performanceScore === existing.performanceScore && list.count > existing.count)
  ) {
    bestByChild.set(key, list);
  }
}

const resolveToplistHref = (list: (typeof toplists)[number]) => {
  const bestKey = `${list.category}:${list.subcategory}:${list.childsubcategory}`;
  const best = bestByChild.get(bestKey);
  if (best && best.slug === list.slug) {
    return childSubcategoryUrl(list.category, list.subcategory, list.childsubcategory);
  }
  return subcategoryToplistUrl(list.category, list.subcategory, list.count, list.keywordSlug);
};

const groups = new Map<
  string,
  {
    categorySlug: string;
    categoryName: string;
    subcategorySlug: string;
    subcategoryName: string;
    lists: typeof toplists;
  }
>();

for (const list of toplists) {
  const key = `${list.category}:${list.subcategory}`;
  const category = categoryMap.get(list.category);
  const subcategory = subcategoryMap.get(key);
  if (!category || !subcategory) continue;
  const existing = groups.get(key);
  if (!existing) {
    groups.set(key, {
      categorySlug: category.slug,
      categoryName: category.name,
      subcategorySlug: subcategory.slug,
      subcategoryName: subcategory.name,
      lists: [list]
    });
  } else {
    existing.lists.push(list);
  }
}

const sortedGroups = [...groups.values()].sort((a, b) => {
  if (a.categoryName !== b.categoryName) return a.categoryName.localeCompare(b.categoryName);
  return a.subcategoryName.localeCompare(b.subcategoryName);
});

for (const group of sortedGroups) {
  group.lists.sort((a, b) => {
    if (b.performanceScore !== a.performanceScore) return b.performanceScore - a.performanceScore;
    return b.count - a.count;
  });
}

const schema = [
  buildBreadcrumbSchema(site, breadcrumbItems),
  buildItemListSchema(
    sortedGroups.flatMap((group) =>
      group.lists.map((list) => ({
        name: list.title,
        url: new URL(resolveToplistHref(list), site).toString()
      }))
    )
  ),
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description,
    url: canonical
  }
];

const breadcrumbLinks = breadcrumbItems.map((item) => ({ name: item.name, href: item.path }));
const ogImage = categories[0]?.image ?? "/logo.svg";
---

<Layout title={title} description={description} canonical={canonical} schema={schema} ogImage={ogImage}>
  <section class="section">
    <div class="page-container">
      <Breadcrumbs items={breadcrumbLinks} />
      <h1 class="mt-4 text-3xl font-semibold">All top lists</h1>
      <p class="mt-3 text-lg text-ink/70">
        Browse by category and subcategory. Best-overall pages link directly to the main category pages.
      </p>
      <div class="mt-6 flex flex-wrap gap-2">
        {categories.map((category) => (
          <a
            class="rounded-full border border-border bg-surface px-4 py-2 text-sm font-medium text-ink/80 transition-colors hover:border-accent hover:text-accent"
            href={`#cat-${category.slug}`}
          >
            {category.name}
          </a>
        ))}
      </div>
    </div>
  </section>

  <section class="section bg-surface">
    <div class="page-container space-y-12">
      {categories.map((category) => {
        const catGroups = sortedGroups.filter((group) => group.categorySlug === category.slug);
        if (!catGroups.length) return null;
        return (
          <div id={`cat-${category.slug}`} class="scroll-mt-24">
            <div class="flex flex-wrap items-baseline justify-between gap-3">
              <h2 class="text-2xl font-semibold">{category.name}</h2>
              <a class="text-sm font-semibold text-accent" href={`/category/${category.slug}/`}>
                Browse {category.name} â†’
              </a>
            </div>
            <div class="mt-6 space-y-10">
              {catGroups.map((group) => (
                <div class="card p-6">
                  <h3 class="text-xl font-semibold">{group.subcategoryName}</h3>
                  <div class="mt-5 grid gap-6 md:grid-cols-2">
                    {group.lists.map((list, index) => {
                      const childKey = `${list.category}:${list.subcategory}:${list.childsubcategory}`;
                      const child = childSubcategoryMap.get(childKey);
                      const isBestOverall = bestByChild.get(childKey)?.slug === list.slug;
                      const image =
                        list.image ??
                        child?.image ??
                        subcategoryMap.get(`${list.category}:${list.subcategory}`)?.image ??
                        categoryMap.get(list.category)?.image ??
                        "/logo.svg";
                      const imageSrcset =
                        list.imageSrcset ??
                        child?.imageSrcset ??
                        subcategoryMap.get(`${list.category}:${list.subcategory}`)?.imageSrcset ??
                        categoryMap.get(list.category)?.imageSrcset;
                      const isLcpCandidate = category.slug === categories[0]?.slug && group.subcategorySlug === catGroups[0]?.subcategorySlug && index === 0;
                      return (
                        <a
                          class="card card-hover grid gap-4 overflow-hidden md:grid-cols-[200px_1fr]"
                          href={resolveToplistHref(list)}
                        >
                          <img
                            class="h-full w-full object-cover"
                            src={image}
                            alt={list.title}
                            loading={isLcpCandidate ? "eager" : "lazy"}
                            fetchpriority={isLcpCandidate ? "high" : undefined}
                            decoding="async"
                            srcset={imageSrcset}
                            sizes="(max-width: 768px) 100vw, 200px"
                            width="400"
                            height="300"
                          />
                          <div class="p-5">
                            <p class="text-xs font-semibold uppercase tracking-[0.25em] text-ink/70">
                              {isBestOverall ? "Best overall" : "Top list"}
                            </p>
                            <h4 class="mt-2 text-lg font-semibold">{list.title}</h4>
                            <p class="mt-2 text-sm text-ink/70">{list.metaDescription}</p>
                          </div>
                        </a>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      })}
    </div>
  </section>
</Layout>

